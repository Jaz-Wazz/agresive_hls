<html>
	<head>
		<link rel="stylesheet" href="main.css">
		<script src="hls.min.js"></script>
	</head>
	<body>
		<video id="player" controls="controls"></video>
		<textarea></textarea>
	</body>
	<script>
		class Buffer
		{
			/** @type Map<number, Segment> */
			segments = new Map();

			/** @type HTMLTextAreaElement */
			text_area;

			/** @type number */
			average_speed = 0;

			constructor(text_area)
			{
				this.text_area = text_area;
			}

			update_statistics()
			{
				// Update average speed.
				let sum = 0;
				this.segments.forEach(value => { sum += value.speed; });
				this.average_speed = sum / this.segments.size;

				// Show statistics.
				this.text_area.textContent = "Buffer:\n";
				this.segments.forEach((value, key) =>
				{
					let status = (value.speed / this.average_speed) < 0.5 ? "bad" : "good";
					this.text_area.textContent += `  Segment ${key} -> ${(value.speed / 131072).toFixed(2)} -> ${status}\n`;
				});
				this.text_area.textContent += `Average speed: ${(this.average_speed / 131072).toFixed(2)}.`;
			}
		}

		class Segment
		{
			/** @type XMLHttpRequest */
			xhr = new XMLHttpRequest();

			/** @type number */
			speed = 0;

			/** @type number */
			start_point = new Date().getTime();

			/** @type Buffer */
			buffer;

			constructor(associated_buffer, url)
			{
				this.buffer = associated_buffer;
				this.xhr.open("GET", url, true);
				this.xhr.responseType = "arraybuffer";
				this.xhr.onprogress = (event) => { this.on_progress(event); }
				this.xhr.send();
			}

			on_progress(event)
			{
				// Update segment speed.
				let elapsed_time = new Date().getTime() - this.start_point;
				let multiplier = 1000 / elapsed_time;
				this.speed = event.loaded * multiplier;

				// Update statistics.
				buffer.update_statistics();
			}
		}

		let buffer = new Buffer(document.getElementsByTagName("textarea")[0]);

		class Loader
		{
			load(context, config, callbacks)
			{
				let url = new URL(context.url);
				let filename = url.pathname.split('/').pop();
				let index = parseInt(filename.match(/\d+/)[0]);

				while(buffer.segments.size < 6)
				{
					let max_index = buffer.segments.size != 0 ? Math.max(... buffer.segments.keys()) : -1;
					max_index++;

					let segment = new Segment(buffer, "http://ia801400.s3dns.us.archive.org/0366d7f8/" + max_index + ".ts");
					buffer.segments.set(max_index, segment);
				}

				if(buffer.segments.has(index))
				{
					let segment = buffer.segments.get(index);

					segment.xhr.onload = function()
					{
						callbacks.onSuccess({data: segment.xhr.response}, {}, context);
						buffer.segments.delete(index);
					};
				}
			}
		}

		let hls = new Hls({fLoader: Loader});
		hls.loadSource('http://ia801400.s3dns.us.archive.org/0366d7f8/index-dvr.m3u8');
		hls.attachMedia(player);
	</script>
</html>
