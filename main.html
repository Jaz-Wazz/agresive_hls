<html>
	<head>
		<link rel="stylesheet" href="main.css">
		<script src="hls.min.js"></script>
	</head>
	<body>
		<video id="player" controls="controls"></video>
		<textarea></textarea>
	</body>
	<script>
		class Buffer
		{
			constructor()
			{
				/** @type Map<number, Segment> */
				this.segments = new Map();
			}
		}

		class Segment
		{
			constructor(url)
			{
				/** @type XMLHttpRequest */
				this.xhr = new XMLHttpRequest();
				this.xhr.open("GET", url, true);
				this.xhr.responseType = "arraybuffer";
				this.xhr.send();

				/** @type number */
				this.speed = 0;
			}
		}

		let metrics = document.getElementsByTagName("textarea")[0];
		let buffer = new Buffer;

		function loader()
		{
			this.load = function(context, config, callbacks)
			{
				let url = new URL(context.url);
				let filename = url.pathname.split('/').pop();
				let index = parseInt(filename.match(/\d+/)[0]);

				for(let i = buffer.segments.size; i < 6; i++)
				{
					let max_index = buffer.segments.size != 0 ? Math.max(... buffer.segments.keys()) : -1;
					max_index++;

					let segment = new Segment("http://ia801400.s3dns.us.archive.org/0366d7f8/" + max_index + ".ts");
					buffer.segments.set(max_index, segment);

					let start_point = new Date().getTime();
					segment.xhr.onprogress = function(event)
					{
						let elapsed_time = new Date().getTime() - start_point;
						let multiplier = 1000 / elapsed_time;
						let bytes_per_sec = event.loaded * multiplier;
						segment.speed = event.loaded * multiplier;

						let average_speed = 0;
						average_speed += buffer.segments.get(0).speed;
						average_speed += buffer.segments.get(1).speed;
						average_speed += buffer.segments.get(2).speed;
						average_speed += buffer.segments.get(3).speed;
						average_speed += buffer.segments.get(4).speed;
						average_speed += buffer.segments.get(5).speed;
						average_speed = average_speed / 5;

						metrics.textContent = "Buffer:\n";
						buffer.segments.forEach(function(value, key)
						{
							// let status = value.speed < average_speed ? "bad" : "good";
							let status = (value.speed / average_speed) < 0.5 ? "bad" : "good";
							metrics.textContent += `    Segment ${key} -> ${(value.speed / 131072).toFixed(2)} -> ${status}\n`;
						});
						metrics.textContent += `Average speed: ${(average_speed / 131072).toFixed(2)}.`;
					};
				}

				if(buffer.segments.has(index))
				{
					let segment = buffer.segments.get(index);

					segment.xhr.onload = function()
					{
						callbacks.onSuccess({data: segment.xhr.response}, {}, context);
						preloaded_segments.delete(index);
					};
				}
			}
		}

		let hls = new Hls({fLoader: loader});
		hls.loadSource('http://ia801400.s3dns.us.archive.org/0366d7f8/index-dvr.m3u8');
		hls.attachMedia(player);
	</script>
</html>
